<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Commands · Skunk</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link rel="canonical" href="https://github.com/tpolecat/skunktutorial/Command.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Skunk
</a>
<div class="version-number">
0.3.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../tutorial/Index.html" class="page">Tutorial</a>
  <ul>
    <li><a href="../tutorial/Setup.html" class="page">Setup</a></li>
    <li><a href="../tutorial/Query.html" class="page">Queries</a></li>
    <li><a href="../tutorial/Command.html" class="active page">Commands</a></li>
    <li><a href="../tutorial/Transactions.html" class="page">Transactions</a></li>
    <li><a href="../tutorial/Channels.html" class="page">Channels</a></li>
    <li><a href="../tutorial/Tracing.html" class="page">Tracing</a></li>
  </ul></li>
  <li><a href="../reference/Index.html" class="page">Reference</a>
  <ul>
    <li><a href="../reference/Sessions.html" class="page">Sessions</a></li>
    <li><a href="../reference/TwiddleLists.html" class="page">Twiddle Lists</a></li>
    <li><a href="../reference/Encoders.html" class="page">Encoders</a></li>
    <li><a href="../reference/Fragments.html" class="page">Fragments</a></li>
    <li><a href="../reference/Identifiers.html" class="page">Identifiers</a></li>
    <li><a href="../reference/Concurrency.html" class="page">Concurrency</a></li>
    <li><a href="../reference/SchemaTypes.html" class="page">Schema Types</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Skunk</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Skunk
</a>
<div class="version-number">
0.3.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../tutorial/Index.html" class="page">Tutorial</a>
  <ul>
    <li><a href="../tutorial/Setup.html" class="page">Setup</a></li>
    <li><a href="../tutorial/Query.html" class="page">Queries</a></li>
    <li><a href="../tutorial/Command.html" class="active page">Commands</a></li>
    <li><a href="../tutorial/Transactions.html" class="page">Transactions</a></li>
    <li><a href="../tutorial/Channels.html" class="page">Channels</a></li>
    <li><a href="../tutorial/Tracing.html" class="page">Tracing</a></li>
  </ul></li>
  <li><a href="../reference/Index.html" class="page">Reference</a>
  <ul>
    <li><a href="../reference/Sessions.html" class="page">Sessions</a></li>
    <li><a href="../reference/TwiddleLists.html" class="page">Twiddle Lists</a></li>
    <li><a href="../reference/Encoders.html" class="page">Encoders</a></li>
    <li><a href="../reference/Fragments.html" class="page">Fragments</a></li>
    <li><a href="../reference/Identifiers.html" class="page">Identifiers</a></li>
    <li><a href="../reference/Concurrency.html" class="page">Concurrency</a></li>
    <li><a href="../reference/SchemaTypes.html" class="page">Schema Types</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Skunk</a></li>
  <li><a href="../tutorial/Index.html">Tutorial</a></li>
  <li>Commands</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#commands" name="commands" class="anchor"><span class="anchor-link"></span></a>Commands</h1>
<p>This section explains how to construct and execute commands.</p><div class="callout note "><div class="callout-title">Definition</div>
<p>A <em>command</em> is a SQL statement that does not return rows.</p></div>
<h2><a href="#simple-command" name="simple-command" class="anchor"><span class="anchor-link"></span></a>Simple Command</h2>
<p>First let&rsquo;s look at a command that sets the session&rsquo;s random number seed.</p>
<pre class="prettyprint"><code class="language-scala">val a: Command[Void] =
  sql&quot;SET SEED TO 0.123&quot;.command
// a: Command[Void] = Query(sql = &quot;SET SEED TO 0.123&quot;, encoder = Codec(void))
</code></pre>
<p>Observe the following:</p>
<ul>
  <li>We are using the <a href="../reference/Fragments.html">sql interpolator</a> to construct a <a href="https://static.javadoc.io/org.tpolecat/skunk-core_2.12/0.3.2/skunk/Fragment.html" title="skunk.Fragment"><code>Fragment</code></a>, which we then turn into a <a href="https://static.javadoc.io/org.tpolecat/skunk-core_2.12/0.3.2/skunk/Command.html" title="skunk.Command"><code>Command</code></a> by calling the <code>command</code> method.</li>
  <li><code>Command</code> is parameterized by its input type. Because this command has no parameters the input type is <code>Void</code>.</li>
</ul>
<p>The command above is a <em>simple command</em>.</p><div class="callout note "><div class="callout-title">Definition</div>
<p>A <em>simple command</em> is a command with no parameters.</p></div>
<p>The same <a href="https://www.postgresql.org/docs/10/protocol-flow.html#id-1.10.5.7.4">protocol</a> that executes simple queries also executes simple commands. Such commands can be passed directly to <a href="https://static.javadoc.io/org.tpolecat/skunk-core_2.12/0.3.2/skunk/Session.html#execute" title="skunk.Session"><code>Session.execute</code></a>.</p>
<pre class="prettyprint"><code class="language-scala">// assume s: Session[IO]
s.execute(a) // IO[Completion]
</code></pre>
<p>On success a command will yield a <a href="https://static.javadoc.io/org.tpolecat/skunk-core_2.12/0.3.2/skunk/data/Completion.html" title="skunk.data.Completion"><code>Completion</code></a>, which is an ADT that encodes responses from various commands. In this case our completion is simply the value <code>Completion.Set</code>.</p>
<h2><a href="#parameterized-command" name="parameterized-command" class="anchor"><span class="anchor-link"></span></a>Parameterized Command</h2>
<p>Now let&rsquo;s add a parameter to the command.</p>
<pre class="prettyprint"><code class="language-scala">val c: Command[String] =
  sql&quot;DELETE FROM country WHERE name = $varchar&quot;.command
// c: Command[String] = Query(
//   sql = &quot;DELETE FROM country WHERE name = $1&quot;,
//   encoder = Codec(varchar)
// )
</code></pre>
<p>Observe that we have interpolated a value called <code>varchar</code>, which has type <code>Encoder[String]</code>. This works the same way as with queries. See the previous chapter for more information about statement parameters.</p>
<p>The command above is an <em>extended command</em>.</p><div class="callout note "><div class="callout-title">Definition</div>
<p>An <em>extended command</em> is a command with parameters, or a simple command that is executed via the extended query protocol.</p></div>
<p>The same protocol Postgres provides for executing extended queries is also used for extended commands, but because the return value is always a single <code>Completion</code> the end-user API is more limited.</p>
<p>Here we use the extended protocol to attempt some deletions.</p>
<pre class="prettyprint"><code class="language-scala">// assume s: Session[IO]
s.prepare(c).use { pc =&gt;
  pc.execute(&quot;xyzzy&quot;) *&gt;
  pc.execute(&quot;fnord&quot;) *&gt;
  pc.execute(&quot;blech&quot;)
} // IO[Completion]
</code></pre>
<p>If we&rsquo;re slighly more clever we can do this with <code>traverse</code> and return a list of <code>Completion</code>.</p>
<pre class="prettyprint"><code class="language-scala">// assume s: Session[IO]
s.prepare(c).use { pc =&gt;
  List(&quot;xyzzy&quot;, &quot;fnord&quot;, &quot;blech&quot;).traverse(s =&gt; pc.execute(s))
} // IO[List[Completion]]
</code></pre>
<p>And if we&rsquo;re yet more clever we can turn <code>pc</code> into an fs2 <code>Pipe</code>.</p>
<pre class="prettyprint"><code class="language-scala">// assume s: Session[IO]
Stream.resource(s.prepare(c)).flatMap { pc =&gt;
  Stream(&quot;xyzzy&quot;, &quot;fnord&quot;, &quot;blech&quot;).through(pc.pipe)
} // Stream[IO, Completion]
</code></pre>
<h3><a href="#contramapping-commands" name="contramapping-commands" class="anchor"><span class="anchor-link"></span></a>Contramapping Commands</h3>
<p>Similar to <code>map</code>ping the <em>output</em> of a Query, we can <code>contramap</code> the <em>input</em> to a command or query. Here we provide a function that turns an <code>Info</code> into a <code>String ~ String</code>, yielding a <code>Command[Info]</code>.</p>
<pre class="prettyprint"><code class="language-scala">case class Info(code: String, hos: String)

val update2: Command[Info] =
  sql&quot;&quot;&quot;
    UPDATE country
    SET    headofstate = $varchar
    WHERE  code = ${bpchar(3)}
  &quot;&quot;&quot;.command                                          // Command[String ~ String]
     .contramap { case Info(code, hos) =&gt; code ~ hos } // Command[Info]
// update2: Command[Info] = Query(
//   sql = &quot;&quot;&quot;
//     UPDATE country
//     SET    headofstate = $1
//     WHERE  code = $2
//   &quot;&quot;&quot;,
//   encoder = Encoder(varchar, bpchar(3))
// )
</code></pre>
<p>However in this case the mapping is entirely mechanical. Similar to <code>gmap</code> on query results, we can skip the boilerplate and <code>gcontramap</code> directly to an isomosphic case class.</p>
<pre class="prettyprint"><code class="language-scala">val update3: Command[Info] =
  sql&quot;&quot;&quot;
    UPDATE country
    SET    headofstate = $varchar
    WHERE  code = ${bpchar(3)}
  &quot;&quot;&quot;.command          // Command[String ~ String]
     .gcontramap[Info] // Command[Info]
// update3: Command[Info] = Query(
//   sql = &quot;&quot;&quot;
//     UPDATE country
//     SET    headofstate = $1
//     WHERE  code = $2
//   &quot;&quot;&quot;,
//   encoder = Encoder(varchar, bpchar(3))
// )
</code></pre>
<h2><a href="#list-parameters" name="list-parameters" class="anchor"><span class="anchor-link"></span></a>List Parameters</h2>
<p>Sometimes we want to repeat a parameter, for instance if we&rsquo;re using an <code>IN</code> clause. Here is a command that takes a <code>List[String]</code> as an argument and turns it into a list of <code>varchar</code>. We must specify the length when constructing the statement.</p>
<pre class="prettyprint"><code class="language-scala">def deleteMany(n: Int): Command[List[String]] =
  sql&quot;DELETE FROM country WHERE name IN (${varchar.list(n)})&quot;.command

val delete3 = deleteMany(3) // takes a list of size 3
// delete3: Command[List[String]] = Query(
//   sql = &quot;DELETE FROM country WHERE name IN ($1, $2, $3)&quot;,
//   encoder = Encoder(varchar, varchar, varchar)
// )
</code></pre>
<p>Sometimes we want to repeat a <em>group</em> of parameters, for instance if we&rsquo;re doing a bulk <code>INSERT</code>. To do this we take advantage of two combinators, first <code>.values</code> which takes an encoder and returns a new encoder that wraps its generated SQL in parens, and then <code>.list</code> as above.</p>
<pre class="prettyprint"><code class="language-scala">def insertMany(n: Int): Command[List[(String, Short)]] = {
  val enc = (varchar ~ int2).values.list(n)
  sql&quot;INSERT INTO pets VALUES $enc&quot;.command
}

val insert3 = insertMany(3)
// insert3: Command[List[(String, Short)]] = Query(
//   sql = &quot;INSERT INTO pets VALUES ($1, $2), ($3, $4), ($5, $6)&quot;,
//   encoder = Encoder(varchar, int2, varchar, int2, varchar, int2)
// )
</code></pre>
<p>You have no doubt noticed that there is a lack of safety with list parameters because the required length of the list is not represented in the type. In practice this is usually unavoidable because the length of the list is typically not known statically. However it is <em>also</em> typically the case that the command will be prepared with a specific list in mind, and in this case we can improve safety by passing the list itself (i.e., not just its length) to <code>.list</code>, and we get back an encoder that only works with that specific list.</p>
<pre class="prettyprint"><code class="language-scala">def insertExactly(ps: List[(String, Short)]): Command[ps.type] = {
  val enc = (varchar ~ int2).values.list(ps)
  sql&quot;INSERT INTO pets VALUES $enc&quot;.command
}

val pairs = List[(String, Short)]((&quot;Bob&quot;, 3), (&quot;Alice&quot;, 6))
// pairs: List[(String, Short)] = List((&quot;Bob&quot;, 3), (&quot;Alice&quot;, 6))

// Note the type!
val insertPairs = insertExactly(pairs)
// insertPairs: Command[pairs.type] = Query(
//   sql = &quot;INSERT INTO pets VALUES ($1, $2), ($3, $4)&quot;,
//   encoder = Encoder(varchar, int2, varchar, int2)
// )
</code></pre>
<p>We can pass <code>pairs</code> to <code>execute</code>.</p>
<pre class="prettyprint"><code class="language-scala">// assume s: Session[IO]
s.prepare(insertPairs).use { pc =&gt; pc.execute(pairs) }
</code></pre>
<p>However attempting to pass anything <em>other than</em> <code>pairs</code> is a type error.</p>
<pre class="prettyprint"><code class="language-scala">// assume s: Session[IO]
s.prepare(insertPairs).use { pc =&gt; pc.execute(pairs.drop(1)) }
// error: type mismatch;
//  found   : List[(String, Short)]
//  required: repl.MdocSession.MdocApp.pairs.type
// s.prepare(insertPairs).use { pc =&gt; pc.execute(pairs.drop(1)) }
//                                               ^^^^^^^^^^^^^
</code></pre>
<p>See the full example below for a demonstration of these techniques.</p>
<h2><a href="#summary-of-command-types" name="summary-of-command-types" class="anchor"><span class="anchor-link"></span></a>Summary of Command Types</h2>
<p>The <em>simple command protocol</em> (i.e., <code>Session#execute</code>) is slightly more efficient in terms of message exchange, so use it if:</p>
<ul>
  <li>Your command has no parameters; and</li>
  <li>you will be using the query only once per session.</li>
</ul>
<p>The <em>extend command protocol</em> (i.e., <code>Session#prepare</code>) is more powerful and more general, but requires additional network exchanges. Use it if:</p>
<ul>
  <li>Your command has parameters; and/or</li>
  <li>you will be using the command more than once per session.</li>
</ul>
<h2><a href="#full-example" name="full-example" class="anchor"><span class="anchor-link"></span></a>Full Example</h2>
<p>Here is a complete program listing that demonstrates our knowledge thus far, using the service pattern introduced earlier.</p>
<pre class="prettyprint"><code class="language-scala">import cats.effect._
import cats.implicits._
import natchez.Trace.Implicits.noop
import skunk._
import skunk.codec.all._
import skunk.implicits._

// a data type
case class Pet(name: String, age: Short)

// a service interface
trait PetService[F[_]] {
  def insert(pet: Pet): F[Unit]
  def insert(ps: List[Pet]): F[Unit]
  def selectAll: F[List[Pet]]
}

// a companion with a constructor
object PetService {

  // command to insert a pet
  private val insertOne: Command[Pet] =
    sql&quot;INSERT INTO pets VALUES ($varchar, $int2)&quot;
      .command
      .gcontramap[Pet]

  // command to insert a specific list of pets
  private def insertMany(ps: List[Pet]): Command[ps.type] = {
    val enc = (varchar ~ int2).gcontramap[Pet].values.list(ps)
    sql&quot;INSERT INTO pets VALUES $enc&quot;.command
  }

  // query to select all pets
  private val all: Query[Void, Pet] =
    sql&quot;SELECT name, age FROM pets&quot;
      .query(varchar ~ int2)
      .gmap[Pet]

  // construct a PetService
  def fromSession[F[_]](s: Session[F])(
    implicit ev: MonadCancel[F, Throwable]
  ): PetService[F] =
    new PetService[F] {
      def insert(pet: Pet): F[Unit] = s.prepare(insertOne).use(_.execute(pet)).void
      def insert(ps: List[Pet]): F[Unit] = s.prepare(insertMany(ps)).use(_.execute(ps)).void
      def selectAll: F[List[Pet]] = s.execute(all)
    }

}

object CommandExample extends IOApp {

  // a source of sessions
  val session: Resource[IO, Session[IO]] =
    Session.single(
      host     = &quot;localhost&quot;,
      user     = &quot;jimmy&quot;,
      database = &quot;world&quot;,
      password = Some(&quot;banana&quot;),
    )

  // a resource that creates and drops a temporary table
  def withPetsTable(s: Session[IO]): Resource[IO, Unit] = {
    val alloc = s.execute(sql&quot;CREATE TEMP TABLE pets (name varchar, age int2)&quot;.command).void
    val free  = s.execute(sql&quot;DROP TABLE pets&quot;.command).void
    Resource.make(alloc)(_ =&gt; free)
  }

  // some sample data
  val bob     = Pet(&quot;Bob&quot;, 12)
  val beagles = List(Pet(&quot;John&quot;, 2), Pet(&quot;George&quot;, 3), Pet(&quot;Paul&quot;, 6), Pet(&quot;Ringo&quot;, 3))

  // our entry point
  def run(args: List[String]): IO[ExitCode] =
    session.flatTap(withPetsTable).map(PetService.fromSession(_)).use { s =&gt;
      for {
        _  &lt;- s.insert(bob)
        _  &lt;- s.insert(beagles)
        ps &lt;- s.selectAll
        _  &lt;- ps.traverse(p =&gt; IO.println(p))
      } yield ExitCode.Success
    }

}
</code></pre>
<p>Running this program yields the following.</p>
<pre><code>Pet(Bob,12)
Pet(John,2)
Pet(George,3)
Pet(Paul,6)
Pet(Ringo,3)
</code></pre>
<h2><a href="#experiment" name="experiment" class="anchor"><span class="anchor-link"></span></a>Experiment</h2>
<ul>
  <li>Change <code>insertMany</code> to pass an <code>Int</code> to <code>.list</code> and then pass a size other than the length of <code>beagles</code> and observe the error.</li>
  <li>Add a unique constraint on <code>name</code> in the DDL and then violate it by inserting two pets with the same name. Follow the hint in the error message to add an handler that recovers gracefully.</li>
  <li>Change the service constructor to prepare the statements once on construction, rather than each time <code>insert</code> is called.</li>
</ul>
<script type="text/javascript" src="../js/link_fix.js"></script>

<div class="source-github">
The source code for this page can be found <a id="source-link" href="https://github.com/tpolecat/skunk/tree/v0.3.2/modules/docs/target/mdoc/tutorial/Command.md">here</a>.
</div>

<script type="text/javascript">jQuery(function(){sourceUrlFix('https://github.com/tpolecat/skunk/tree/v0.3.2/modules/docs/target/mdoc/tutorial/Command.md')});</script>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../tutorial/Transactions.html">Transactions</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../tutorial/Command.html#commands" class="header">Commands</a>
  <ul>
    <li><a href="../tutorial/Command.html#simple-command" class="header">Simple Command</a></li>
    <li><a href="../tutorial/Command.html#parameterized-command" class="header">Parameterized Command</a></li>
    <li><a href="../tutorial/Command.html#list-parameters" class="header">List Parameters</a></li>
    <li><a href="../tutorial/Command.html#summary-of-command-types" class="header">Summary of Command Types</a></li>
    <li><a href="../tutorial/Command.html#full-example" class="header">Full Example</a></li>
    <li><a href="../tutorial/Command.html#experiment" class="header">Experiment</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2022</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.3.2', 'https://github.com/tpolecat/skunk')});</script>


</html>
